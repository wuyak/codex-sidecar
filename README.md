# codex-sidecar

把它当成“Codex 会话的本地回放网页”就行：开起来后你能更舒服地看对话、翻译思考、导出复盘。

它是**静态 UI**（`ui/` 目录下的 HTML/JS/CSS）：不需要 Node、不需要构建；你改完文件后，刷新浏览器就能看到效果。

想直接照着点：看本文的「我一般这么用（30 秒）」和「UI 按钮怎么用」即可。

## 我一般这么用（30 秒）

```bash
./run.sh
```

正常情况下它会自动打开浏览器；如果没有自动打开，就手动访问：
- `http://127.0.0.1:8787/ui`

接着你看一眼右侧 Dock：
- 如果按钮写着“停止监听”，说明已经在跟着你的会话跑了
- 如果写着“开始监听”，点一下就行（常见于 `./run.sh --ui`）

如果你打开页面后看不到任何会话：
- 先确认你已经用 Codex 跑过对话（它需要有“会话记录”可读）
- 如果你不知道 `CODEX_HOME` 是什么：先不用管；默认就是 `~/.codex`
- 只有你自己改过 Codex 数据目录时，才需要这样指定：`CODEX_HOME=/你的路径 ./run.sh`

## 你大概率会拿它干这些

- 更清晰地看：用户输入 / 回答 / 思考 / 工具输出（长内容可折叠、diff 更好读）
- 多会话切换：右侧会话标签栏（像书签一样）
- 子代理会话分层：主会话 + 子会话切换条；会话管理里可折叠/展开子会话
- 思考翻译：自动/手动，支持重试/重译
- 终端确认提醒：卡在“需要你批准”的时候会提醒你回终端处理
- 离线回看 & 导出：导入某个历史会话文件，然后导出 Markdown 复盘

## 它不会干这些（放心用）

- 不会在网页里“控制 Codex 执行”
- 不会修改你的会话文件（只读）
- 不会把内容上传到任何地方  
  - 例外：你开启“翻译”并配置了外部翻译服务时，思考文本会发到你选的服务

## 只开 UI（不自动开始实时跟随）

你想先把页面开起来，慢慢调设置，或者只离线回看/导出时，用（页面会显示“开始监听”，你需要的时候再点）：

```bash
./run.sh --ui
```

## 静态 UI（不用 build）

- UI 是 `ui/` 下的静态资源（`ui/index.html`、`ui/app/*.js`、`ui/styles.css`…），服务端会以 `/ui/*` 提供。
- 日常改 UI：直接编辑这些文件，然后刷新浏览器即可（不需要 `pnpm install` / `pnpm build`）。

## UI 按钮怎么用（我按“你看到的按钮”讲清楚）

> 说明：本文说的“长按”，大概按住 **0.5 秒**不松手。

### 1) 右侧 Dock（7 个按钮，从上到下）

| 按钮 | 你会看到什么 | 单击会发生什么 | 长按会发生什么 |
|---|---|---|---|
| **设置**（⚙） | 右侧弹出“设置”抽屉 | 打开/关闭设置抽屉 | — |
| **导入对话**（📥） | 弹出“导入对话”弹窗（带日历 + 文件列表） | 打开/关闭导入弹窗 | — |
| **精简显示**（⚡） | 提示文字会变成“精简显示：已开启/已关闭” | 在“精简/全量”之间切换（只影响显示） | 打开“精简显示设置”弹窗（勾选要保留哪些块） |
| **翻译**（🌐） | 提示文字会变成“自动翻译：已开启/已关闭” | 开/关“自动翻译”（立即生效） | 打开“翻译设置”抽屉（选 Provider、填 Key/Token 等） |
| **开始监听 / 停止监听**（▶/■） | 按钮文字就是当前状态 | 开始或停止实时跟随最新会话 | — |
| **清空消息**（🗑） | 时间线会被清空 | 清空当前页面里的消息列表（不删会话文件） | — |
| **关闭/长按重启**（⏻） | 单击会先弹确认框 | 退出 sidecar（停止监听并关闭服务） | 直接重启 sidecar（不弹确认，卡住时很好用） |

### 2) 顶部两条“书签栏”（会话怎么切）

页面顶部有两条标签栏（像浏览器书签）：
- **会话标签栏**：正在监听的“在线会话”
- **展示标签栏**：你通过“导入对话”加进来的“离线会话”（只用于回看/导出）

常用操作（很实用）：
- **单击标签**：切换到这个会话
- **长按标签**：就地重命名（`all` 不能改名）
- **点标签上的关闭按钮**：把这个会话从标签栏里“收起来/关闭监听”  
  - 别担心：不会删文件；你随时能在“会话管理 → 关闭监听”里恢复
  - 如果这是一个“带子代理”的会话：子会话也会一起被收起来（避免子会话单独刷屏）
- **如果某个标签有未读**：点它会跳到未读位置；继续点会继续跳到下一条未读

如果你觉得这两条标签栏挡视线：
- 点右下角“会话管理” → 顶部有个 **“标签页栏”** 开关，把它关掉即可（随时可再打开）

### 2.5) 子代理会话怎么切（主 / 子1 / 子2 …）

当你当前会话里出现子代理（subagent）时，消息区顶部会出现一条 **“子代理会话切换条”**：
- **主**：主会话
- **1/2/3…**：对应子会话（子代理）

它的目标是：**子会话不刷屏**（不会在会话标签栏里铺满一排），但你依然能一键切到任意子会话查看/导出。

### 3) 右下角三个按钮（别忽略）

页面右下角有三个按钮：
- **回到页面顶部**
- **回到页面底部**
- **会话管理**（菜单按钮）：打开“会话管理”抽屉（重命名/导出/关闭监听/恢复/清除）

### 4) 会话管理（重命名 / 导出 / 关闭监听 / 恢复 / 清除）

打开方式：点右下角 **“会话管理”**（菜单按钮）。

你会看到三块列表：
- **监听中**：在线会话（你正在跟随的）
- **展示中**：离线会话（你导入的，用于回看/导出）
- **关闭监听**：你手动“收起来”的会话（可随时恢复）

每个会话右侧会有一排小按钮（鼠标放上去会提示中文）：
- **折叠/展开子会话**：仅当该会话含子代理时出现；展开后会显示 `子1/子2…` 条目（可单独导出/关闭监听/清除）
- **重命名**：改显示名（只影响本机 UI，不改原始会话文件）
- **导出（长按设置）**：导出 Markdown（长按可选“精简/全量、译文/原文”）
- **关闭监听 / 开启监听**：把会话从标签栏收起来/恢复回来
- **清除对话**：把这个会话从列表里清掉（不会删文件；有新输出或你重启后会自动回来）  
  - 适合清理“僵尸会话/不想再看到但又不想永久关闭监听”的情况

还有一个小技巧（非常好用）：
- **在会话条目上长按**：会复制这个会话对应的源 `rollout-*.jsonl` 路径（方便你定位文件）

### 5) 导入对话（离线回看）

打开方式：点右侧 Dock 的 **“导入对话”**。

弹窗里你会看到：
- 一个输入框：可以填 `sessions/YYYY/MM/DD/rollout-*.jsonl`  
  - 你就算粘贴“完整绝对路径”也可以，UI 会尽量帮你提取成 `sessions/...`
- 一个 `+` 按钮：把你输入的文件加入“展示中”
- 一个刷新按钮：刷新离线文件列表（你刚跑完一段会话、想立刻找最新文件时很有用）
- 左侧日历 + 右侧文件列表：按日期筛选并快速点选文件

导入成功后：
- 顶部会出现“展示标签栏”（离线标签）
- 会话管理里会出现在“展示中”
- 这类离线会话**不会影响**你正在监听的在线会话（你可以放心回看/导出）

### 6) 精简显示（⚡ 怎么用才舒服）

你觉得时间线太“吵”时就开它：
- **单击⚡**：立刻切到精简/全量
- **长按⚡**：打开“精简显示设置”，你可以决定精简模式下要保留哪些内容

小建议：
- 只想看结果：精简里只保留“回答 / 思考 / 终端确认”就很清爽
- 需要排障：切回全量（工具输出、参数会更完整）

### 7) 翻译（🌐）和“思考块”怎么操作

你会遇到两种“翻译”入口：

**A. Dock 的 🌐（全局开关）**
- **单击🌐**：开/关“自动翻译”（立即生效）  
- **长按🌐**：打开“翻译设置”（选 Provider、填 Key/Token、设超时）

**B. 每条思考右侧的“翻译/重试/重译”按钮（单条处理）**
- 没译文时显示“翻译”（或失败时显示“重试”）
- 已有译文时显示“重译”

思考块本身也能点（很直觉）：
- **有中文后**：点击思考块可在 **EN / ZH** 之间切换  
- **手动翻译模式**下：如果还没中文，点击思考块会触发翻译  
- **自动翻译模式**下：如果还没中文，点击思考块只会提示“等待翻译…”（真正重发请点右侧“翻译/重试”）

### 8) 设置（⚙）怎么配（我把每一项翻成“人话”）

打开方式：点 Dock 的 **设置（⚙）**。

你会看到这些项：
- **监视目录（固定）**：sidecar 正在读的会话目录（通常是 `~/.codex`）  
  - 如果你 Codex 目录不在这里：用 `CODEX_HOME=/你的路径 ./run.sh` 重启来指定（UI 里改不了）
- **配置目录（只读）**：sidecar 把配置写到哪里（默认在本仓库的 `config/sidecar/`）  
  - 真正落盘文件是 `config/sidecar/config.json`（已被 `.gitignore` 忽略）
- **自动开始**：开了以后，你打开网页/重启后端时，会尽量自动开始监听（省得每次点“开始监听”）
- **回答提示音 / 终端确认提示音**：  
  - “终端确认”建议开一个明显点的声音（它是提醒你回终端批准/拒绝）
  - 不想吵就选“无”
- **主题 / 字体大小 / 按钮大小**：纯 UI 观感设置（随便调，觉得舒服就行）
- **并行会话**：同时跟随最近 N 个会话  
  - 觉得信息太多/机器吃力：调小（例如 1）  
  - 你经常同时跑多个会话：保留默认即可
- **回放行数**：刚开始监听时，从文件尾部补多少行历史  
  - 想“刚打开就看到更多上下文”：调大  
  - 想“更轻量、更快”：调小

最后别忘了点 **保存**。

### 9) 翻译设置怎么配（最常见的三种）

打开方式：
- 长按 Dock 的 **🌐**，或
- 在“设置”抽屉里点 **翻译设置**

你需要做的事就是三步：
1) 把“自动翻译”选成你想要的（开启/关闭）  
2) 选择 Provider  
3) 把必填项填完，点 **保存**（保存后会自动做一次“翻译自检”）

Provider 怎么选（按你手头有什么）：
- **HTTP**：你有一个现成的翻译 HTTP 接口（最通用）  
  - 支持多个 Profiles：可以为不同接口存不同 URL/Token，然后切换 selected
- **GPT（Responses API 兼容）**：你有 OpenAI / 网关 / 代理  
  - Base URL 可以不填（默认会用 `https://api.openai.com/v1`）  
  - 但 **Model** 和 **API Key** 必填
- **NVIDIA（NIM）**：你用 NVIDIA 的接口  
  - **Base URL / Model / API Key** 必填  
  - RPM=0 表示不做限速（默认就是 0）

提示：Key/Token 输入框默认是“密码框”（`********`），点旁边的小眼睛可以临时显示，刷新页面会自动重新隐藏。

## 文档

本仓库只保留一个 `README.md`（本文）。

## 发给别人用（别把自己的 Key 一起发了）

### 配置与敏感信息

- 你的本机设置会写到：`config/sidecar/config.json`（已加入 `.gitignore`，不会被提交到 GitHub）。
- 如果你要给别人一个“模板”：用 `config/sidecar/config.example.json`（无敏感信息）。
- UI 会把敏感字段用 `********` 隐藏，减少截图/复制时的泄露风险。

### 打包发给别人（不改代码、开箱即用）

前提：对方有 Python 3（无需额外依赖）。

- 方式 A：直接打包当前 Git 版本（推荐）
  - `git archive --format=zip --output codex_sidecar.zip HEAD`
  - 对方解压后运行：`./run.sh`

- 方式 B：只发一条命令（对方自行 clone）
  - `git clone <your_repo_url>`
  - `./run.sh`

### 做成可执行文件（可行但需要额外工具）

可以用 PyInstaller 为每个系统单独打包（Windows/macOS/Linux 各自构建一次）。

注意：这个工具会读取目标机器上的 Codex 会话目录（默认 `~/.codex`），所以对方机器也需要能访问到自己的会话记录。

已提供构建脚本（会把 `ui/` 静态资源一并打包到可执行文件中）：

```bash
./scripts/build_exe.sh
```

Windows（PowerShell）：

```powershell
.\scripts\build_exe.ps1
```

构建产物：
- Linux/macOS：`dist/codex-sidecar`
- Windows：`dist/codex-sidecar.exe`

运行示例：

```bash
./dist/codex-sidecar --ui
```

## 版本
本项目不维护单独的版本号，直接以 Git 提交为准（例如：`git rev-parse --short HEAD`）。

## 说明（给想二次开发/排查的人）

如果你要看更完整的原理、接口、配置键名、以及“这个行为到底在哪实现的”，可以直接从下方的「目录结构」开始按文件名定位源码。

<details>
<summary>目录结构（给想看源码的人）</summary>

- `codex_sidecar/`（后端）
  - `controller.py`: 监听线程生命周期与配置控制（供 HTTP handler 调用）
  - `watcher.py`: 跟随 rollout 读取→`/ingest`；TUI tool gate 提示；翻译通过 `watch/` 子模块异步回填
  - `watch/`: watcher 侧子模块（rollout 路径/进程扫描/跟随策略/翻译批处理与队列）
    - `watch/rollout_extract.py`: rollout JSONL 单条记录 → UI 事件提取（assistant/user/tool/reasoning）
  - `control/`: 控制面子模块（translator schema / translator 构建 / 配置校验）
- `server.py`: HTTP+SSE 启动器（绑定 state/controller，启动 ThreadingHTTPServer）
- `ui/`：默认 UI（静态源码，服务端以 `/ui/*` 提供）
- `scripts/`：启动脚本实现（`run.sh` + `_common.sh`）
- `config/sidecar/`：本地配置落点（默认；已加入 `.gitignore`）
  - 实际配置：`config/sidecar/config.json`（本机使用，已加入 `.gitignore`）
  - 示例配置：`config/sidecar/config.example.json`（可提交/发布，无敏信息）
- `old/`：归档（历史草稿/快照/旧 tools 结构）
- `helloagents/`: 知识库（`CHANGELOG.md` / `INDEX.md` / `modules/` / `archive/` / `plan/`）

</details>
