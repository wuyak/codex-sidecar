# 变更提案: 架构优化（无功能变更）

## 需求背景
近期新增了离线“展示中/导入对话”、通用翻译接口与导出串行化等能力后，项目的关键链路（HTTP 控制面、watcher 轮询、导出数据流）出现了以下维护与性能问题：

1. **重复实现与分散逻辑**：同类能力在多个入口复制粘贴（例如 handler 的 JSON 解析、翻译入口、错误响应），导致修改风险增大。
2. **空转开销**：部分轮询在“无新增/无变化”时仍会执行不必要的文件打开/读取，造成额外 IO 与系统调用。
3. **结构复杂度**：关键入口文件过于臃肿，存在大量“样板式”代码，使真实业务逻辑被淹没，后续继续迭代成本上升。

本次目标是在**不改变现有功能与行为**的前提下，对项目整体结构做一次系统性检查与重构，降低开销、减少冗余与复杂度，提升可维护性。

## 变更内容
1. 重构 HTTP Handler：抽离通用的 JSON body 读取、错误响应、翻译路由等样板代码，避免重复与不一致。
2. 优化 watcher 周边轮询：对无增量场景做短路（early-return），减少空转 IO。
3. 增补覆盖测试：为关键重构点补齐单元测试，确保“无功能变更”可回归验证。

## 影响范围
- **模块:**
  - `codex_sidecar/http/*`
  - `codex_sidecar/watch/*`
  - `tests/*`
  - `helloagents/wiki/*`、`helloagents/CHANGELOG.md`
- **文件:**
  - `codex_sidecar/http/handler.py`
  - `codex_sidecar/watch/tui_gate.py`
  - `tests/test_*.py`
- **API:** 不新增、不删除；仅内部实现重构（保持兼容）。
- **数据:** 无。

## 核心场景

### 需求: 降低空转开销
**模块:** watcher / tui gate

#### 场景: 无新增日志/无新增 jsonl
当 rollout/jsonl 或 codex-tui.log 没有增长时，轮询应避免重复打开文件与读取操作，保持 UI 功能不变但降低资源消耗。

### 需求: 降低重复与复杂度
**模块:** HTTP handler

#### 场景: 多端点重复的 JSON 解析与错误返回
不同端点对 JSON body 的读取与校验应复用统一实现；翻译接口（control/offline）应走同一条内部路径，减少分叉与维护负担。

## 风险评估
- **风险:** 重构引入行为微差（HTTP 错误码/字段细节、翻译接口返回形状）
- **缓解:** 单元测试覆盖 + 保持原响应结构 + 分阶段 git commit（便于回滚与定位）

