# 变更提案: 前端 UI 全量重构（Vue 3 + Vite）

## 需求背景

当前 UI 采用纯静态 HTML/CSS + Vanilla JS（ESM，无构建）的实现方式。随着功能增加，出现了明显的维护与稳定性问题：

- 交互与状态散落在多处：按钮/书签/抽屉/未读/翻译状态由手工事件与 DOM 操作拼接，容易在切换会话、回填更新等场景出现错乱。
- UI 组件一致性不足：缺少统一的组件规范（hover/active/disabled/loading/focus），导致体验不稳定且难以扩展。
- 浮层与“最上层显示”问题：书签/抽屉/toast 等浮层的 z-index 与布局依赖细节，新增功能更容易产生遮挡冲突。
- 长列表 + 高频 SSE 更新对性能要求高：手工维护的渲染与增量更新逻辑复杂，迭代时容易引入性能回归。

本次目标是把 UI 全量重构为“组件化、可扩展、易维护且性能稳定”的结构，同时保持后端 API 不变。

## 变更内容

1. 引入 `Vue 3 + Vite`，将 UI 重写为组件化应用（构建期引入，运行期仍由 sidecar 静态分发）。
2. 后端接口保持不变：继续使用 `/events`（SSE）与 `/api/*`（数据与控制面）。
3. 把关键稳定性策略显式建模：SSE 更新/重连、刷新期保护、`op=update` 原位回填、会话切换与未读逻辑。
4. 统一浮层体系：抽屉/对话框/toast 通过 Teleport 统一挂载，规范 z-index token，避免“无法置顶”类问题。
5. 保留并强化性能：长列表采用窗口化/虚拟列表，Markdown 渲染与格式化做缓存与增量更新。

## 影响范围

- **模块:** 仅 UI（`tools/codex_thinking_sidecar/codex_thinking_sidecar/ui*`）与构建流程；watcher/controller/http API 不改动。
- **API:** 不变（`/api/messages`、`/api/threads`、`/api/config`、`/api/control/*`、`/events` 等）
- **数据:** 不变（浏览器 localStorage：书签重命名/隐藏会话/皮肤等需保持兼容）

## 核心场景

### 需求: 会话浏览与切换（书签/未读/隐藏）
**模块:** UI

#### 场景: 高频 SSE 下切换会话不串线
- SSE 高频推送期间切换会话，当前视图不闪烁、不乱序；非当前会话未读计数正确。

#### 场景: 书签重命名稳定可用
- 重命名、取消、提交（Enter/失焦）不会误触发切换、不会丢输入。

### 需求: 长列表渲染与性能稳定
**模块:** UI

#### 场景: 万级消息量可用
- 单会话 1 万条消息仍可滚动/切换/导出，不出现明显卡顿或崩溃。

### 需求: 配置与监听控制
**模块:** UI

#### 场景: 配置保存与监听生命周期
- 配置保存/恢复；开始/停止/重启/清空/退出行为与现有一致，状态展示正确。

### 需求: 翻译与思考块交互
**模块:** UI

#### 场景: 自动翻译回填与 EN/ZH 切换
- 未译时默认 EN；译文回填后默认 ZH；单击可切换；`op=update` 不改变时间线位置。

#### 场景: 手动翻译与“重译”
- 手动模式点击触发翻译；in-flight 防抖；失败可见且可重试。

## 风险评估

- **风险: 引入 Node 构建链**
  - 缓解: 构建仅用于生成静态资源；运行仍为 Python sidecar 静态分发；保留 legacy UI 回滚路径。
- **风险: 全量重写导致回归**
  - 缓解: 以“核心场景”为验收基线，逐项对齐；引入可快速切换的 legacy UI。
- **风险: 性能回归（长列表 + SSE）**
  - 缓解: 将窗口化与增量更新作为强约束，开发实施中加入性能对比与压测检查。

