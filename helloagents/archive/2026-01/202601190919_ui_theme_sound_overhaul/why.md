# 变更提案: UI 主题与提示音整体重做（Manifest 驱动）

## 需求背景
当前 UI 的“皮肤/提示音”属于早期试验产物：样式与资源零散、可维护性差，且难以扩展到“精选主题/精选音效 + 用户自定义资源（放在 sidecar 配置目录）”的目标形态。

本次变更允许**破坏性变更**：不保留现有皮肤与提示音的兼容性，优先追求“逻辑纯净、架构直接、可扩展且可控”的实现。

## 产品分析

### 目标用户与场景
- **用户群体:** 本地运行 Codex Sidecar 的开发者/研究者，希望更舒适地旁路查看会话输出与工具确认状态。
- **使用场景:** 长时间运行、频繁产生回答输出；偶发出现 tool gate 需要回到终端确认；希望通过声音/主题快速感知状态与减轻视觉噪音。
- **核心痛点:** 主题差异不够明确且难维护；提示音选择少、不可扩展；无法自然引入用户自定义音效。

### 价值主张与成功指标
- **价值主张:** 用“Manifest（数据）+ 统一 tokens（样式）+ 受限文件访问（安全）”把 UI 主题/提示音做成可维护、可扩展且默认体验更好的系统。
- **成功指标:**
  - 主题：提供 3–4 个**精选**主题，差异明显（颜色/对比/圆角/阴影/间距/字体），且可读性/可用性不下降。
  - 提示音：内置约 6–10 个高质量音效；“回答输出/终端确认等待”分别可选一个音效；可关闭。
  - 自定义音效：用户把音频文件放入 sidecar 配置目录下的指定子目录后，UI 下拉中自动出现（无需构建、无需 CDN）。

### 人文关怀
- 听觉敏感/公共环境：提供“关闭”选项，默认不过度打扰；保持提示音短促、音量适中并可在 UI 明确预览。
- 可访问性：设置项语义清晰、图标按钮均有 `aria-label`；错误在就近位置提示，避免 `alert()` 打断。

## 变更内容
1. 重做主题系统：以 manifest 描述主题 tokens，UI 运行时应用；移除现有 `skin` 实现与旧主题列表。
2. 重做提示音系统：以 manifest 描述内置音效；新增“回答输出音效/终端确认音效”两项配置；移除旧 `notify_sound` 逻辑与资源。
3. 支持自定义音效：从 sidecar 配置目录的 `sounds/` 子目录扫描并提供给 UI；后端提供受限的“列出/读取音效文件”接口。

## 影响范围
- **模块:** `ui/`（设置面板、主题、声音播放、样式 tokens）、`codex_sidecar/`（配置 schema、HTTP API）
- **文件:** 预计涉及 `ui/index.html`、`ui/styles.css`、`ui/app/*`、`codex_sidecar/config.py`、`codex_sidecar/http/handler.py` 等
- **API:** 新增 `GET /api/sfx`、`GET /api/sfx/file/<name>`（名称以实际实现为准）
- **数据:** sidecar 配置字段变更（破坏性）：`notify_sound` → `notify_sound_assistant` / `notify_sound_tool_gate`

## 核心场景

### 需求: 选择精选主题
**模块:** UI
用户在设置中选择 3–4 个精选主题之一，主题切换立即生效并本机记忆。

#### 场景: 切换主题
在设置抽屉中选择主题
- 预期结果：整体配色/圆角/阴影/间距/字体呈现明显差异
- 预期结果：可读性与交互可用性不下降（对比度、焦点 ring、禁用态等清晰）

### 需求: 配置提示音（回答输出 / 终端确认）
**模块:** UI + 后端配置
用户可分别为“回答输出”和“终端确认等待（tool gate）”选择一个音效，选择后可预览并持久化。

#### 场景: 选择并预览内置音效
在设置抽屉中选择内置音效
- 预期结果：下拉变更后立即播放预览（遵循浏览器手势限制）
- 预期结果：保存后，未来事件触发时播放对应音效

### 需求: 自定义音效（配置目录扫描）
**模块:** 后端 API + UI
用户把音频文件放入 sidecar 配置目录下的 `sounds/`，刷新/重新打开设置后能在下拉中选择。

#### 场景: 放入本地文件后自动出现
把 `my.ogg` 放入 `${config_home}/sounds/`
- 预期结果：UI 下拉出现 “自定义：my.ogg”
- 预期结果：选择后可预览；触发事件时可播放

## 风险评估
- **风险:** 路径穿越/越权读取（通过文件名构造读取配置目录其他文件）
  - **缓解:** 文件名白名单 + 路径 resolve 后父目录校验 + 扩展名/大小限制 + 只允许读取 `${config_home}/sounds/` 内文件
- **风险:** 资源体积膨胀
  - **缓解:** 内置音效数量控制在 6–10 个且尽量短促；自定义文件只扫描允许的扩展并可设置单文件大小上限

