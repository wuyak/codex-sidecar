# 变更提案: 后端架构分层优化（Phase 3）

## 需求背景
当前 sidecar 后端已完成多轮功能迭代与局部重构，但仍存在少数“大文件/大类”承担过多职责的问题（如 watcher/controller 的核心实现）。这会带来：
- 模块边界不清晰，修改容易牵一发动全身
- 可测试性与可维护性下降（回归风险上升）
- 后续修复/优化需要更高的上下文成本

本轮目标是在**不改动任何对外行为（UI/API/脚本/导入路径）**的前提下，继续做“分层、解耦、可测试化”的纯重构。

## 变更内容
1. 继续拆分 `watch` / `controller` 中的单体实现：抽离独立的职责模块（例如去重、rollout 行处理、文件 tail）。
2. 保持对外兼容：沿用既有 facade 入口与 import 路径，内部实现可迁移但外部调用不受影响。
3. 补齐知识库同步：把本轮重构的关键变化写入知识库与变更历史，确保文档与代码一致。

## 影响范围
- **模块:** `codex_sidecar/watch/*`、`codex_sidecar/controller_core.py`（内部结构）
- **文件:** 以实际提交为准（本轮为“重构/解耦”，不包含功能变更）
- **API:** 无（保持兼容）
- **数据:** 无

## 核心场景
### 需求: 维持监听与翻译链路稳定（不改功能）
**模块:** watch/controller

#### 场景: Sidecar 后端持续监听 rollout 并推送 UI
- 预期结果：仍能按现有逻辑发现/跟随会话文件、去重、推送消息、后台翻译与 patch 更新。

#### 场景: 运行时热更新配置
- 预期结果：translator/provider、follow 策略等运行时配置更新行为不变；测试与 smoke 验证通过。

## 风险评估
- **风险:** 纯重构仍可能引入边界回归（线程/锁、去重、tail 偏移等）。
- **缓解:** 采用“facade（兼容入口）+ core（真实实现）”与小步提交；每次大改动后执行单测与 `compileall`；必要时补最小回归测试。

