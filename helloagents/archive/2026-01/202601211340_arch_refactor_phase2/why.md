# 变更提案: 项目整体架构优化（Phase 2，无功能变更优先）

## 需求背景
项目近期在“离线展示 + 统一翻译 + 导出串行化 + watcher 进程定位降耗”等方向迭代较多，虽然功能已可用，但核心代码的复杂度与耦合度继续上升，主要体现在：

1. **关键入口过重**：后端 `http/handler.py`、`controller.py`、`watcher.py` 与前端 `ui/app/control/wire.js`、`ui/app/main.js` 承担了过多职责，阅读与修改成本高。
2. **重复与分叉**：同类逻辑在多处实现（例如：请求 JSON 解析/错误返回、翻译批处理/单条路径、轮询读取/尾部读取），容易出现“改一处漏一处”。
3. **空转与不必要回路**：在无增量/无变化时仍存在部分重复打开/读取或重复计算（尤其是 watcher 与 UI 的刷新/导出路径），造成额外资源开销与交互不确定性。

本阶段目标是先做一次**系统化的架构检查与重构设计**，再按设计分批落地，确保：

- **不改动现有功能**（行为保持一致，接口保持兼容）
- **降低开销**（减少空转 IO/无效循环/重复构建）
- **降低复杂度与冗余**（减少重复代码、减少“多入口多分支”）
- **解耦关键链路**（让模块职责更单一、入口更薄、边界更清晰）

## 约束与非目标
### 约束
- 不新增“可见功能”作为前置条件；仅当重构过程中发现“缺失会导致架构无法收敛/长期成本爆炸”时，才提出必要的最小能力补齐（并记录原因）。
- 每个大改动完成后进行一次 git commit，便于回滚与定位。
- 保持现有测试全部通过（`unittest` + `compileall` + JS `node --check`）。

### 非目标
- 将“指定 rel”改造成复杂的可搜索/可过滤文件选择器（当前收益不匹配成本）。
- 引入新的框架/依赖（优先使用标准库与现有结构）。

## 成功标准（可验证）
1. 单测全部通过；端到端交互无回归（离线展示/翻译/导出/监听）。
2. 核心入口文件的“样板代码”显著减少；关键链路更容易定位与修改。
3. watcher/UI 在空闲期的 IO/CPU 空转进一步下降（以“无新增输出、无用户操作”场景为基准）。

## 当前结构快照（用于定位重构重点）
### 后端数据流
1. watcher 跟随 `rollout-*.jsonl` 增量 → `POST /ingest` 入库（`SidecarState`）
2. UI 通过 `GET /api/messages` / `GET /api/threads` 拉取初始数据
3. UI 通过 `GET /events` SSE 接收增量（含 `op=update` 的译文回填）
4. 离线展示通过 `GET /api/offline/messages` 直接解析文件得到与 Live 相同 schema
5. 翻译通过 `POST /api/control/translate_text`（批量/单条）完成，不依赖 watcher 状态

### 前端关键入口
- `ui/app/main.js`：应用编排（状态、刷新、事件流、渲染协调）
- `ui/app/control/wire.js`：交互 wiring（按钮/抽屉/导入/导出/设置等）

## 风险评估
- **风险:** 重构引入“微行为差异”（错误码/默认值/边界 case）
- **缓解:** 分批提交 + 单测覆盖关键路径 + 保持返回形状不变 + 优先内部 helper（少引入新抽象）

