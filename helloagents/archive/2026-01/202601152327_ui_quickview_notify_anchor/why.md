# 变更提案: UI 快速浏览/提醒/落点稳定 + 翻译/审批边界 + 全局优化

## 需求背景
sidecar 以“旁路只读”的方式读取 `CODEX_HOME/sessions/**/rollout-*.jsonl` 并在浏览器 UI 中展示。随着多会话并行、长时间挂起与翻译支路引入，出现了以下体验痛点：

1. **快速扫读成本高**：工具输出/系统提示占据大量屏幕空间，难以只看“输入/输出/思考”三类核心内容。
2. **关键状态容易错过**：终端需要批准（tool gate）或重要输出出现时，用户可能在其它会话或滚动位置，缺少醒目的提醒。
3. **单击切换导致落点漂移**：思考块 EN/ZH 切换、代码块详情/摘要切换会改变高度，导致再次单击时鼠标落点不再位于同一块，产生“点空/点到别的块”的错觉。
4. **翻译边界条件需要系统化**：翻译失败/超时/空译文、手动重试、回放期聚合翻译等链路需要明确的边界与展示策略，避免噪音、雪崩或误判。
5. **完成需求后需要整体优化**：在完成上述需求后，对 UI/Watcher/翻译链路做一次整体代码分析与可维护性优化（不引入构建链，保持纯静态优势）。

## 变更内容
1. 新增 **“精简显示/快速浏览”** 模式：仅展示 `用户输入 / 回答输出 / 思考` 三类块，便于快速扫读；支持一键恢复全量。
2. 新增 **右下角提醒**：当出现“终端等待批准（tool gate）”或其他关键信息时，右下角弹出提示，可辅助定位当前状态。
3. 实现 **“落点不漂移”**：对思考块与代码块的单击切换增加滚动锚点修正，确保切换后鼠标落点仍在同一块内。
4. 翻译链路 **边界条件审计与固化**：失败不污染内容区；错误以状态字段回填；节流/去重/聚合策略明确且可解释。
5. 工具批准信息（需求2）**展示策略复核**：UI 只显示有用信息（工具、命令、justification），避免冗余（如 `call_id`）与误导。
6. 完成以上需求后，进行 **全局代码分析与优化**：重构边界更清晰、命名更一致、模块更易读，确保长时间挂起与多会话切换稳定（仍保持纯静态、无构建）。

## 影响范围
- **模块:** `rollout_sidecar`（UI 展示、事件流、装饰层、翻译状态、tool gate 提示）
- **文件:** 主要集中在 `tools/codex_thinking_sidecar/codex_thinking_sidecar/ui/` 下的 ESM 模块；少量后端 watcher/translator 展示字段
- **API:** 无破坏性变更；可能新增 UI 侧本地状态字段（localStorage）与少量客户端逻辑
- **数据:** 不修改原始 `rollout-*.jsonl`；不引入服务端持久化数据结构

## 核心场景

### 需求: 精简显示（快速浏览）
**模块:** UI

#### 场景: 快速扫读
- 用户开启“精简显示”后，仅看到：输入 / 输出 / 思考
- 关闭后恢复全量（工具调用/工具输出/tool gate 等重新可见）

### 需求: 终端批准提醒（tool gate）
**模块:** UI + Watcher

#### 场景: 需要终端批准时的可见性
- 当终端等待批准时，UI 能明确提示“需要回到终端确认”
- 提示内容简洁且有用，不展示无帮助字段（如 call_id）

### 需求: 单击切换落点稳定
**模块:** UI

#### 场景: 思考块 EN/ZH 切换
- 单击切换显示模式后，页面滚动自动修正，保持鼠标落点仍在该思考块内

#### 场景: 代码块 详情/摘要 切换
- 单击切换后同样保持落点稳定，避免“第二次单击点到别处”

### 需求: 翻译边界与错误机制
**模块:** Watcher + UI

#### 场景: 翻译失败/超时
- 不把告警写进思考内容区
- UI 明确展示失败状态并允许手动重试

