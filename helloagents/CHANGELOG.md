# Changelog

## [Unreleased]
- 新增：UI 控制面（保存配置、开始/停止监听、清空显示）+ 短命令 `./ui.sh`。
- 优化：`./ui.sh` 当端口已有健康服务时直接打开已有 UI 并退出，避免端口占用反复报错。
- 新增：翻译 Provider 预留与 UI 切换（stub/none/http）。
- 新增：HTTP Profiles（可保存多个翻译 API 配置并手动切换）。
- 调整：`./run.sh` 默认沿用已保存配置（未显式传参时不再用默认值覆盖）。
- 新增：HTTP Token 字段（可用于 Header 鉴权或替换 URL 中 `{token}`，方便对接 DeepLX）。
- 新增：UI 显示模式（仅中文/仅英文/中英对照）。
- 修复：HTTP 翻译适配更多常见入参/回参字段，降低“无译文”的概率。
- 优化：保存配置时提示重启监听以立即生效；UI 响应增加 no-cache 避免浏览器缓存旧页面。
- 修复：为 `/api/config` 与 `/api/translators` 增加向后兼容字段，避免旧版 UI（缓存）无法读取配置导致“配置丢失”错觉。
- 优化：控制面板接口请求增加 cache-bust，API 响应标记为 no-store，避免浏览器缓存导致配置不刷新。
- 优化：控制面板新增“调试信息”面板，显示配置来源/Profiles 概览与加载失败原因（不展示 token/url）。
- 修复：保存配置时不再在 Provider≠HTTP 的情况下清空已保存的 HTTP Profiles，避免误操作导致配置丢失。
- 调整：配置持久化迁移到 XDG（`~/.config/codex-thinking-sidecar/config.json`），备份机制简化为单文件 `config.json.bak`；Profiles 为空时 UI 提示一键恢复，后端拒绝保存空 Profiles 以防误覆盖。
- 诊断：HTTP 翻译失败时输出去敏后的告警日志（终端可见）。
- 新增：HTTP 适配 `translate.json`（硅基流动 translate.js 形式，表单提交）。
- 优化：UI 列表改为从上到下（新内容在底部），并展示用户输入/工具调用与输出/最终回答。
- 调整：仅翻译思考类内容（reasoning summary / agent_reasoning），工具输出与最终回答不翻译。
- 新增：WSL2/Linux 下可选“进程优先定位”当前会话文件（扫描 `/proc/<pid>/fd`），更精准地跟随正在进行的会话。
- 新增：会话切换列表固定在页面左侧 sidebar，滚动到中后段也可随时切换。
- 新增：UI 配置支持“自动开始监听（UI）”与进程匹配规则。
- 新增：CLI 支持 `--follow-codex-process` / `--codex-process-regex` / `--allow-follow-without-process`。
- 优化：tool_call/tool_output 展示更友好（`shell_command` 命令块高亮、tool_output 提取 Exit/耗时/Output 正文，并保留“原始输出/参数”可展开）。
- 新增：UI 右下角悬浮“↑ 顶部 / ↓ 底部”按钮，便于快速跳转页面上下。
- 优化：消息时间戳统一按北京时间展示（不再额外显示 UTC 行）。
- 优化：tool_call 默认折叠展示（点击展开），摘要更智能地跳过 `set -euo pipefail` 等 bash prologue（`update_plan` 例外：直接渲染）。
- 优化：tool_output 默认展示精简的 “Ran … + 关键输出摘要”，并移除 call_id/Exit/耗时 等噪音字段。
- 优化：对 Codex 的 “• Edited … (+x -y)” 改动摘要做结构化渲染（按文件分卡片、diff 行高亮、避免长行强制换行）。
- 优化：`shell_command` 的 `tool_output` 对 `rg` 输出做更智能的折叠（只展示命中的文件路径 + 嵌套的 `\\n` 行数估计 + 其余匹配数量）。
- 优化：`shell_command` 的 `tool_output` 默认直接展示终端风格块（`• Ran ...` + `│/└` 树形摘要），并在“详情”中展示完整命令与更多输出。
- 优化：隐藏 `shell_command/view_image` 的 `tool_call` 行，避免与 `tool_output` 重复；并调整树形缩进/`|| true` 换行，更贴近终端样式。
- 优化：`tool_output` 的“详情”按钮移动到时间戳行（更省空间），点击后直接展开完整详情（不再二次折叠）。
- 优化：`tool_output` 的“详情/收起”改为摘要与完整内容互斥切换（避免展开后出现两条重复块）。
- 优化：命令摘要换行优先在 `|` / `&&` / `||` 处分段，避免参数被孤立到单独一行导致观感割裂。
- 优化：meta 行为工具输出/工具调用/输入/回答补充“类型 + 工具名”标识，统一信息位置。
- 修复：预扫描 `tool_call` 建立 call_id→tool 索引，解决部分 `tool_output` 无法识别工具而展示 raw JSON 的问题。
- 优化：`apply_patch` 详情使用统一 diff 高亮（`+/-/@@`）渲染，便于快速扫读增删改。
- 修复：diff 渲染不再“每行空一行”，行距与分段更紧凑。
- 优化：复制按钮改为小图标（⧉），避免遮挡内容。
- 优化：用户输入（user_message）正文改为 Markdown 渲染，且不再在正文重复“用户”标签（统一放在 meta 行）。
- 优化：隐藏 `apply_patch` 的 `tool_call` 行；`apply_patch` 的 `tool_output` 改为终端风格摘要，并在“详情”中提供补丁内容可复制。
- 优化：`update_plan` 不再折叠展示，按“计划→说明”输出并使用 Markdown 排版，移除原始参数与工具元信息。
- 优化：回答内容（assistant_message）改为 Markdown 渲染。
- 新增：所有消息的文本块/代码块右上角增加“复制”按钮。
- 优化：思考块（`reasoning_summary`/`agent_reasoning`）改为 Markdown 渲染，并将“思考（EN/ZH）”移到时间戳同行。
- 调整：↑ 顶部 / ↓ 底部悬浮按钮移动到左侧。
- 重构：UI HTML 从 `server.py` 抽离到 `tools/codex_thinking_sidecar/codex_thinking_sidecar/ui/index.html`，便于后续分层与迭代。
- 修复：UI Markdown 渲染支持有序列表（`1.` / `1)`），避免回答分点在 UI 中丢失。
- 优化：配置区从主页面移到右侧“配置”抽屉；主页面首行仅保留快捷控制（配置/开始/停止/清空）。
- 新增：手动退出 Sidecar（`/api/control/shutdown` + UI 按钮），便于无需手动 kill PID 的情况下关闭进程。
- 优化：Codex 的改动摘要不再额外展示“原始文本”二次折叠层，减少冗余。
- 重构：UI 静态资源进一步分层为 `ui/index.html` + `ui/styles.css` + `ui/app.js`，服务端提供 `/ui/*` 静态路由。
- 新增：会话侧栏支持折叠为“圆点模式”，hover 查看会话信息以节省屏幕空间。
