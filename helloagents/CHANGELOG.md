# Changelog

## [Unreleased]
- 移除：内置 SDK 控制模式（`src/codex-sdk`、`/api/sdk/*`、UI 底部 composer），聚焦旁路只读并降低代码复杂度。
- 重构：拆分 `watcher.py`，抽离 `watch/*`（rollout 路径/进程扫描/跟随策略/翻译批处理与队列），提升可读性与可维护性。
- 重构：进一步抽离 rollout JSONL 单条记录解析/提取到 `watch/rollout_extract.py`，Watcher 更聚焦“读行→入库→翻译入队”。
- 重构：拆分 `server.py`，抽离 `http/*`（内存 state / HTTP 路由与 SSE / UI 静态资源），提升可读性与后续演进空间。
- 重构：拆分 `controller.py`，抽离 `control/*`（translator schema / translator 构建 / 配置校验），降低控制面耦合。
- 重构：TUI tool gate tail/解析抽离到 `watch/tui_gate.py`；UI 在 SSE 断线重连后自动回源同步，提升长时间挂着稳定性。
- UI：断线恢复/长时间挂着时回源同步会话列表（`/api/threads`），避免侧栏漏会话/排序漂移。
- UI: 拆分 `ui/app/render.js`，引入子目录实现（保持纯静态，无构建）
- 重构：进一步拆分渲染/Markdown：`ui/app/render/*`（core/thinking/tool/md_cache）与 `ui/app/markdown/*`（inline/table）
- UI: 优化列表刷新/切换性能：使用 `DocumentFragment`，刷新期间暂存 SSE 并在结束后回放；思考区增加“ZH 翻译中”占位提示（对照/英文模式可见）。
- UI: 优化频繁切换时的重绘成本：Markdown 渲染按消息缓存；翻译回填尽量原位更新（不整行 replace）。
- UI: 多会话消息列表引入“视图缓存 + 非当前会话 SSE 缓冲/切回回放”，切换更快；缓冲溢出或切到 `all` 时自动回源刷新。
- UI: SSE 缓冲策略优化：仅为已缓存的会话视图缓冲；在 `all` 视图时也会为已缓存会话缓冲，且 `op=update` 不再触发侧栏重绘。
- UI: SSE 会话缓冲对 `op=update` 做按消息 id 覆盖合并，减少翻译回填期间的缓冲溢出与不必要的回源刷新。
- UI: 事件流分层：拆分 `ui/app/events.js` → `ui/app/events/*`（timeline/buffer/stream），并对刷新期间 `ssePending` 的 `op=update` 做按 id 合并，降低译文回填压力。
- UI: 刷新期 SSE `ssePending` 增加长度上限与溢出兜底（溢出后自动回源 `refreshList()`），提升长时间挂着稳定性。
- UI: 装饰分层：`decorate/core.js` 复用 `decorate/copy_hold.js` 并抽离 `decorate/tool_toggle.js`，去重并提升可读性。
- UI: 侧栏分层：拆分 `sidebar.js` → `sidebar/*`（labels/tabs），保留 facade 导出不变。
- UI: 工具函数分层：拆分 `utils.js` → `utils/*`（time/id/color/json/clipboard/error），保留 facade 导出不变。
- UI: 格式化分层：拆分 `format/wrap.js` → `format/wrap/*`（command/lines/tree/rg/output），保留 facade 导出不变。
- UI: 列表分层：拆分 `list.js` → `list/*`（threads/refresh/bootstrap），保留 facade 导出不变。
- UI: 工具渲染分层：拆分 `render/tool.js` → `render/tool/*`（call/output），保留 facade 导出不变。
- UI: 思考渲染分层：拆分 `render/thinking.js` → `render/thinking/*`（visibility/derive/patch/block），并对 `op=update`（译文回填）优先走原位 patch 降低 DOM churn。
- UI: 侧栏会话列表渲染降频：高频 SSE 下合并刷新，减少重排/重绘。
- UI: 侧栏会话列表增量渲染：复用 tab 节点并仅重排/更新，进一步降低 DOM churn。
- UI: 长列表懒渲染：刷新列表时对较早行延后装饰（idle 分片 `decorateRow`），降低一次性重绘卡顿。

- UI: 拆分 `ui/app/markdown.js` / `ui/app/decorate.js`，引入子目录实现（保持纯静态，无构建）
- 新增：UI 控制面（保存配置、开始/停止监听、清空显示）+ 短命令 `./ui.sh`。
- 优化：`./ui.sh` 当端口已有健康服务时直接打开已有 UI 并退出，避免端口占用反复报错。
- 新增：翻译 Provider 预留与 UI 切换（stub/none/http/openai）。
- 新增：GPT（Responses API 兼容）翻译 Provider（支持 OpenAI/兼容中转站如 right.codes；鉴权支持 Authorization/x-api-key；可选 reasoning_effort）。
- 新增：HTTP Profiles（可保存多个翻译 API 配置并手动切换）。
- 调整：`./run.sh` 默认沿用已保存配置（未显式传参时不再用默认值覆盖）。
- 新增：HTTP Token 字段（可用于 Header 鉴权或替换 URL 中 `{token}`，方便对接 DeepLX）。
- 新增：UI 显示模式（仅中文/仅英文/中英对照）。
- 修复：HTTP 翻译适配更多常见入参/回参字段，降低“无译文”的概率。
- 优化：保存配置时提示重启监听以立即生效；UI 响应增加 no-cache 避免浏览器缓存旧页面。
- 修复：为 `/api/config` 与 `/api/translators` 增加向后兼容字段，避免旧版 UI（缓存）无法读取配置导致“配置丢失”错觉。
- 优化：控制面板接口请求增加 cache-bust，API 响应标记为 no-store，避免浏览器缓存导致配置不刷新。
- 优化：控制面板新增“调试信息”面板，显示配置来源/Profiles 概览与加载失败原因（不展示 token/url）。
- 修复：保存配置时不再在 Provider≠HTTP 的情况下清空已保存的 HTTP Profiles，避免误操作导致配置丢失。
- 调整：translator_config 支持按 Provider 分区保存（`http/openai`）并在保存时合并，避免切换 Provider 覆盖其它配置。
- 调整：配置持久化迁移到 XDG（`~/.config/codex-thinking-sidecar/config.json`），备份机制简化为单文件 `config.json.bak`；Profiles 为空时 UI 提示一键恢复，后端拒绝保存空 Profiles 以防误覆盖。
- 诊断：HTTP 翻译失败时输出去敏后的告警日志（终端可见）。
- 新增：HTTP 适配 `translate.json`（硅基流动 translate.js 形式，表单提交）。
- 优化：UI 列表改为从上到下（新内容在底部），并展示用户输入/工具调用与输出/最终回答。
- 调整：仅翻译思考类内容（reasoning summary / agent_reasoning），工具输出与最终回答不翻译。
- 新增：WSL2/Linux 下可选“进程优先定位”当前会话文件（扫描 `/proc/<pid>/fd`），更精准地跟随正在进行的会话。
- 新增：会话切换列表固定在页面左侧 sidebar，滚动到中后段也可随时切换。
- 新增：UI 配置支持“自动开始监听（UI）”与进程匹配规则。
- 新增：CLI 支持 `--follow-codex-process` / `--codex-process-regex` / `--allow-follow-without-process`。
- 优化：tool_call/tool_output 展示更友好（`shell_command` 命令块高亮、tool_output 提取 Exit/耗时/Output 正文，并保留“原始输出/参数”可展开）。
- 新增：UI 右下角悬浮“↑ 顶部 / ↓ 底部”按钮，便于快速跳转页面上下。
- 优化：消息时间戳统一按北京时间展示（不再额外显示 UTC 行）。
- 优化：tool_call 默认折叠展示（点击展开），摘要更智能地跳过 `set -euo pipefail` 等 bash prologue（`update_plan` 例外：直接渲染）。
- 优化：tool_output 默认展示精简的 “Ran … + 关键输出摘要”，并移除 call_id/Exit/耗时 等噪音字段。
- 优化：对 Codex 的 “• Edited … (+x -y)” 改动摘要做结构化渲染（按文件分卡片、diff 行高亮、避免长行强制换行）。
- 优化：`shell_command` 的 `tool_output` 对 `rg` 输出做更智能的折叠（只展示命中的文件路径 + 嵌套的 `\\n` 行数估计 + 其余匹配数量）。
- 优化：`shell_command` 的 `tool_output` 默认直接展示终端风格块（`• Ran ...` + `│/└` 树形摘要），并在“详情”中展示完整命令与更多输出。
- 优化：隐藏 `shell_command/view_image` 的 `tool_call` 行，避免与 `tool_output` 重复；并调整树形缩进/`|| true` 换行，更贴近终端样式。
- 优化：`tool_output` 的“详情”按钮移动到时间戳行（更省空间），点击后直接展开完整详情（不再二次折叠）。
- 优化：`tool_output` 的“详情/收起”改为摘要与完整内容互斥切换（避免展开后出现两条重复块）。
- 优化：命令摘要换行优先在 `|` / `&&` / `||` 处分段，避免参数被孤立到单独一行导致观感割裂。
- 优化：meta 行为工具输出/工具调用/输入/回答补充“类型 + 工具名”标识，统一信息位置。
- 修复：预扫描 `tool_call` 建立 call_id→tool 索引，解决部分 `tool_output` 无法识别工具而展示 raw JSON 的问题。
- 优化：`apply_patch` 详情使用统一 diff 高亮（`+/-/@@`）渲染，便于快速扫读增删改。
- 修复：diff 渲染不再“每行空一行”，行距与分段更紧凑。
- 优化：复制按钮改为小图标（⧉），避免遮挡内容。
- 优化：用户输入（user_message）正文改为 Markdown 渲染，且不再在正文重复“用户”标签（统一放在 meta 行）。
- 优化：隐藏 `apply_patch` 的 `tool_call` 行；`apply_patch` 的 `tool_output` 改为终端风格摘要，并在“详情”中提供补丁内容可复制。
- 优化：`update_plan` 不再折叠展示，按“计划→说明”输出并使用 Markdown 排版，移除原始参数与工具元信息。
- 优化：回答内容（assistant_message）改为 Markdown 渲染。
- 新增：所有消息的文本块/代码块右上角增加“复制”按钮。
- 优化：思考块（`reasoning_summary`/`agent_reasoning`）改为 Markdown 渲染，并将“思考（EN/ZH）”移到时间戳同行。
- 调整：↑ 顶部 / ↓ 底部悬浮按钮移动到右侧。
- 重构：UI HTML 从 `server.py` 抽离到 `tools/codex_thinking_sidecar/codex_thinking_sidecar/ui/index.html`，便于后续分层与迭代。
- 修复：UI Markdown 渲染支持有序列表（`1.` / `1)`）与 `•/◦` 无序列表，避免回答分点在 UI 中丢失。
- 优化：主页面控制收敛到右侧悬浮工具栏（⚙️/▶️/⏹️/🧹/⏻），顶栏仅保留标题与状态。
- 新增：手动退出 Sidecar（`/api/control/shutdown` + UI 按钮），便于无需手动 kill PID 的情况下关闭进程。
- 优化：Codex 的改动摘要不再额外展示“原始文本”二次折叠层，减少冗余。
- 重构：UI 静态资源进一步分层为 `ui/index.html` + `ui/styles.css` + `ui/app.js`，服务端提供 `/ui/*` 静态路由。
- 新增：会话侧栏支持折叠为“圆点模式”，hover 查看会话信息以节省屏幕空间。
- 优化：会话侧栏默认“自动隐藏”，鼠标移到最左侧热区才浮现（进一步释放主内容宽度）。
- 调整：移除会话侧栏“圆点折叠”模式（避免双重折叠），侧栏始终以列表展示。
- 新增：会话侧栏支持自定义标签（右键/双击会话项设置，留空可清除；本机浏览器 localStorage 持久化）。
- 修复：首次启动配置迁移补齐 legacy `.lastgood`/`.bak-*` 扫描，降低“配置丢失且无法恢复”的概率。
- 优化：tool_output 的“详情”不再重复显示工具/call_id/Exit/耗时等头信息，直接展示终端风格正文；并用唯一 id 保证展开/收起不会误操作到其它块。
- 优化：会话侧栏默认折叠并压缩宽度；圆点/标签为每个会话分配稳定色彩，提升多会话区分度。
- 优化：复制按钮缩小并移出代码块顶部避免遮挡；思考分隔线仅在双语同显时出现。
- 优化：顶栏 `/api/messages` 与 `/api/threads` 改为可点击链接，便于快速自检数据源。
- 重构：UI JavaScript 拆分为 ES Modules（解析/格式化/渲染/控制解耦），服务端支持按需静态加载 `/ui/*` 资源。
- 优化：配置抽屉更极简（常用项优先；HTTP Profiles 操作改为图标按钮；非 HTTP Provider 时隐藏 HTTP 配置块）。
- 完善：会话侧栏“圆点模式”使用自定义 tooltip（不依赖浏览器 title），并在圆点上展示消息数徽标提升区分度。
- 修复：tool_output “详情/收起”切换时同步隐藏复制按钮容器，避免出现空白占位/看似重复两条的问题。
- 修复：`apply_patch` 的 Add File/Update File 也提供“详情”展开（显示完整 patch 内容并做 diff 高亮）。
- 优化：用户输入（user_message）检测到前缀为日志/代码时自动拆分为“代码块 + 正文 Markdown”，避免换行被合并导致难以阅读。
- 优化：移除消息正文区域的 hover title（避免出现 `tool_output ...` 这类无意义悬浮提示）；并支持代码块“单击切换详情 / 长按复制”。
- 优化：复制反馈更明显：复制成功会弹出“已复制”提示并自动淡出。
- 优化：HTTP 翻译返回空译文时自动降级为“显示原文 + 顶部告警提示”，避免中文模式下出现（空）。
- 新增：右侧工具栏加入“重启 Sidecar”按钮（杀死并重新拉起新进程，用于开发时快速重载代码）。
- 优化：重启流程基于 `/health` 的 `pid` 判断是否已产生新进程，并在状态栏补充 `sidecar:<pid>` 便于确认。
- 修复：回放/切换文件/重复启动 watcher 时，服务端按消息 id 去重，避免历史消息重复追加。
- 优化：复制交互统一：各内容块支持长按复制（pointerup 触发更稳定）；tool-card 空白区域也可长按复制；移除每条消息右上角复制按钮以减少遮挡。
- 修复：tool_call（如 web_search_call）不再默认折叠，直接以 tool-card 代码块展示调用参数，避免“需要再点开一次”。
- 修复：页面加载/清空显示时同步后端 follow(pin/auto) 状态，避免多会话下“监听跑偏/输出项不一致”的错觉。
- 修复：`apply_patch` 的 tool_call 解析支持“payload 在 call_id 之前”的变体，确保 Add File/Update File 也能展开“详情”。
- 修复：停止监听时若存在翻译请求在途，UI 会显示“停止中”并轮询直到真正停止；watcher 退出后的状态会被自动清理，避免按钮/状态卡住。
- 优化：HTTPServer 启用端口复用（`allow_reuse_address=true`），提升重启 Sidecar 的成功率（避免 TIME_WAIT 导致 EADDRINUSE）。
- 修复：时间线“回跳”从兜底刷新改为排序不变式：UI 收到 SSE 后按 `(timestamp, seq)` 插入到正确位置；服务端为每条消息附加自增 `seq`，会话列表按 `last_seq` 排序，避免不同 timestamp 形态导致排序不稳定。
- 修复：当 `update_plan` 的 tool_call 丢失时，其 `Plan updated` 的 tool_output 不再作为“未知工具”噪音显示。
- 优化：翻译请求去重：Watcher 先做 dedupe 再发起翻译，避免重复消息也重复请求翻译 API。
- 优化：OpenAI/Responses 翻译器增加 LRU 缓存（默认 64 条），减少同内容重复翻译请求。
- 优化：UI 选择 OpenAI Provider 时自动补齐默认 Base URL（right.codes）与默认模型（gpt-4o-mini），减少手动配置成本。
- 重构：翻译实现拆分为 `codex_thinking_sidecar/translators/*`，`translator.py` 仅作为向后兼容的 facade。
- 修复：OpenAI/Responses 翻译鉴权头的 Bearer 前缀自动补空格，避免 `Authorization: Bearersk-...` 导致 401 “缺少 API Key”。
- 修复：停止监听不再提前清空 watcher 线程引用，避免“停止未完成又启动”导致的重复监听/重复翻译请求。
- 调整：保存配置后的“立即生效”改为直接复用右侧 🔄 的“重启 Sidecar”逻辑（更确定，不受 in-flight 翻译请求影响）。
- 调整：right.codes（Codex 网关）默认模型改为 `gpt-5.1`（避免部分 ChatGPT 账号不支持 `gpt-4o-mini` 导致 400，同时较 `gpt-5.2` 更省）。
- 新增：UI Markdown 渲染支持表格（pipe table），输入/输出里含 `|---|` 的表格会渲染为 HTML table。
- 修复：兼容部分网关在 `stream:false` 时仍返回 `text/event-stream`（SSE）；翻译器会解析 SSE 事件并提取 `output_text`，避免把整段 `event: response.created ...` 原样展示到思考内容里。
- 优化：OpenAI/Responses 翻译请求增加 `Accept: application/json`，并缩短翻译 prompt 以减少 token 消耗（同时仍保持 Markdown/代码块保真规则）。
- 修复：OpenAI/Responses 翻译器在批量翻译（`<<<SIDECAR_TRANSLATE_BATCH_V1>>>`）场景下不再额外包裹“只输出译文”的通用翻译 prompt，避免标记行被翻译/改动导致批量解包失败与性能退化。
- 新增：监听 `codex-tui.log` 的 tool gate 状态（`waiting for tool gate` / `tool gate released`），在 UI 中提示“终端等待确认/已确认”，避免需要授权时 UI 看起来卡住。
- 修复：tool gate 长时间等待时不再反复推送“waiting”消息刷屏（仅在状态变化时发一条），避免会话计数膨胀与列表被挤满。
- 修复：tool gate 事件识别改为严格匹配 `codex-tui.log` 的标准日志行（ISO 时间戳 + `INFO waiting/released`），避免工具输出/grep 等包含相同字样时误报“终端等待确认”。
- 修复：`watch/procfs.py` 缺少 `Optional` 导入导致 sidecar 无法启动（`NameError: Optional is not defined`）。
- 新增：多会话场景下支持“锁定跟随”——点击侧边栏会话会将 watcher 固定到该 thread/file（不再按最新文件跳转），避免同时开多个 Codex 会话时 UI 看起来“不是最新”。
- 修复：Markdown 渲染对终端换行更友好（中文不再出现“会 话”这类断词空格），并将 `────` 分隔行独立成块，避免与下一行合并导致结构错乱。
