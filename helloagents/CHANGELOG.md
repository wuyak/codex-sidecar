# Changelog

## [Unreleased]
- 移除：内置 SDK 控制模式（`src/codex-sdk`、`/api/sdk/*`、UI 底部 composer），聚焦旁路只读并降低代码复杂度。
- 重构：拆分 `watcher.py`，抽离 `watch/*`（rollout 路径/进程扫描/跟随策略/翻译批处理与队列），提升可读性与可维护性。
- 重构：进一步抽离 rollout JSONL 单条记录解析/提取到 `watch/rollout_extract.py`，Watcher 更聚焦“读行→入库→翻译入队”。
- 重构：拆分 `server.py`，抽离 `http/*`（内存 state / HTTP 路由与 SSE / UI 静态资源），提升可读性与后续演进空间。
- 重构：拆分 `controller.py`，抽离 `control/*`（translator schema / translator 构建 / 配置校验），降低控制面耦合。
- 重构：TUI tool gate tail/解析抽离到 `watch/tui_gate.py`；UI 在 SSE 断线重连后自动回源同步，提升长时间挂着稳定性。
- UI：断线恢复/长时间挂着时回源同步会话列表（`/api/threads`），避免侧栏漏会话/排序漂移。
- UI: 拆分 `ui/app/render.js`，引入子目录实现（保持纯静态，无构建）
- 重构：进一步拆分渲染/Markdown：`ui/app/render/*`（core/thinking/tool/md_cache）与 `ui/app/markdown/*`（inline/table）
- UI: 优化列表刷新/切换性能：使用 `DocumentFragment`，刷新期间暂存 SSE 并在结束后回放；思考区增加“ZH 翻译中”占位提示（对照/英文模式可见）。
- UI: 优化频繁切换时的重绘成本：Markdown 渲染按消息缓存；翻译回填尽量原位更新（不整行 replace）。
- UI: 多会话消息列表引入“视图缓存 + 非当前会话 SSE 缓冲/切回回放”，切换更快；缓冲溢出或切到 `all` 时自动回源刷新。
- UI: SSE 缓冲策略优化：仅为已缓存的会话视图缓冲；在 `all` 视图时也会为已缓存会话缓冲，且 `op=update` 不再触发侧栏重绘。
- UI: SSE 会话缓冲对 `op=update` 做按消息 id 覆盖合并，减少翻译回填期间的缓冲溢出与不必要的回源刷新。
- UI: 事件流分层：拆分 `ui/app/events.js` → `ui/app/events/*`（timeline/buffer/stream），并对刷新期间 `ssePending` 的 `op=update` 做按 id 合并，降低译文回填压力。
- UI: 刷新期 SSE `ssePending` 增加长度上限与溢出兜底（溢出后自动回源 `refreshList()`），提升长时间挂着稳定性。
- UI: 装饰分层：`decorate/core.js` 复用 `decorate/copy_hold.js` 并抽离 `decorate/tool_toggle.js`，去重并提升可读性。
- UI: 侧栏分层：拆分 `sidebar.js` → `sidebar/*`（labels/tabs），保留 facade 导出不变。
- UI: 工具函数分层：拆分 `utils.js` → `utils/*`（time/id/color/json/clipboard/error），保留 facade 导出不变。
- UI: 格式化分层：拆分 `format/wrap.js` → `format/wrap/*`（command/lines/tree/rg/output），保留 facade 导出不变。
- UI: 列表分层：拆分 `list.js` → `list/*`（threads/refresh/bootstrap），保留 facade 导出不变。
- UI: 工具渲染分层：拆分 `render/tool.js` → `render/tool/*`（call/output），保留 facade 导出不变。
- UI: 思考渲染分层：拆分 `render/thinking.js` → `render/thinking/*`（visibility/derive/patch/block），并对 `op=update`（译文回填）优先走原位 patch 降低 DOM churn。
- UI: 侧栏会话列表渲染降频：高频 SSE 下合并刷新，减少重排/重绘。
- UI: 侧栏会话列表增量渲染：复用 tab 节点并仅重排/更新，进一步降低 DOM churn。
- UI: 会话切换侧栏改为右侧“书签栏”：默认窄条，hover/当前会话自动展开；长按就地重命名；未读以书签徽标展示。
- UI: 长列表懒渲染：刷新列表时对较早行延后装饰（idle 分片 `decorateRow`），降低一次性重绘卡顿。
- UI: 新输出通知改为“未读汇总”（跨会话生效），未读仅在右侧书签徽标展示；移除右下角“铃铛/未读数”形态与清除交互，底部按钮固定为“↓”。
- UI: 书签栏布局与层级优化：书签作为浮层不占用主列表宽度（不制造右侧大空白）；hover/当前会话展开时覆盖主列表；并预留 `data-bm-skin` 皮肤接口（默认 `default`，可切到 `flat`）。
- UI: 右侧工具栏与书签栏定位调整：固定右侧中间（小屏高度自动回退顶部）；并提升图层以覆盖主列表内容（抽屉 overlay 仍为最高优先级）。
- UI: 右侧工具栏与底部浮动按钮统一为 SVG 图标；并用 CSS Variables 统一颜色/危险色/阴影/焦点 ring 等设计 token（应用到按钮/表单/抽屉/tool 卡片/pill 等）。
- UI: 移除 `update_plan` 状态图标中的 emoji（改为纯文本标记），避免视觉噪音与字体不一致。
- UI: 右侧工具栏升级为 Dock 形态（半透明背景/阴影/圆角），并清理顶栏卡片样式与 badge/Markdown/table 细节。
- UI: 配置抽屉增加“皮肤（default/flat/dark）”切换并本机记忆（localStorage），用于快速更换书签/Dock 观感。
- 文档：新增 UI 模板/设计系统调研报告（`helloagents/wiki/modules/ui_template_research.md`），用于后续 UI 美化与渐进式改造评估。
- UI: 右侧操作栏新增“🌐 自动翻译”快捷开关，切换 `auto/manual` 会对运行中的 watcher 立即生效（无需重启）。
- UI：🌐 按钮支持“长按打开翻译设置”（单击仍切换自动翻译）；翻译设置新增“保存翻译设置（热加载）”，保存后立即生效且无需重启进程/会话。
- UI: “翻译设置”抽屉新增“自动翻译（auto/manual）”开关（与 🌐 单击联动），减少主配置抽屉噪音。
- UI: 翻译设置移除 `Auth ENV`（环境变量名）输入项，避免困惑；`API Key/Token` 输入改为密码框，减少误截图泄露风险。
- UI: 快速浏览（⚡）增加展示 `update_plan`（更新计划）块，便于跟踪执行步骤。
- 修复：快速浏览（⚡）可识别 `multi_tool_use.parallel` 包裹的 `update_plan`，并兼容参数被 code fence 包裹/仅出现 `Plan updated` output 的场景，避免“计划更新”在快速浏览中被误隐藏。
- 修复：工具输出（tool_output）的 DOM id 不再包含 `call_id`，并清理 tool_call/tool_output 行内残留 `title`，避免出现 uuid “幽灵标签/悬浮提示”干扰阅读。
- UI: `all` 视图移除每条消息的会话标识 pill（减少信息噪音），并移除会话 tab/消息行的 thread_id 悬停提示（避免遮挡/干扰）。
- UI: 配置抽屉不再区分“基础/高级”，统一为单页表单；表单输入统一 `box-sizing:border-box`，修复文本框宽度溢出。
- 翻译: `auto` 模式仅自动翻译 `reasoning_summary`；`agent_reasoning` 默认改为手动触发，避免翻译队列堆积导致整体变慢。
- 新增：NVIDIA NIM 翻译 Provider（`nvidia`，Chat Completions 兼容）：支持 `NVIDIA_API_KEY` 环境变量鉴权、RPM 节流与 429 退避重试。
- 修复：NVIDIA Provider 响应解析更健壮（兼容 `message.content` 非字符串形态），并提取错误信息便于定位；UI 为 NVIDIA Model 增加常用预设候选。
- 调整：NVIDIA Provider 在 404/疑似未翻译输出时仅在 4 个内置模型内自动回退；同时更新 UI 默认模型为 `moonshotai/kimi-k2-instruct`，并在加载配置时强制纠正到允许列表以避免过时/无权限 id 导致空译文。
- 优化：NVIDIA Model 下拉固定为 4 个候选（kimi/gemma/mistral/ministral），移除“刷新/自定义/测试”入口以简化 UI 并避免误选弱模型。
- 修复：思考块“翻译/重译”按钮现在会校验后端返回并给出明确失败原因；重译失败不再清空旧译文，避免闪烁与“译文丢失”。
- 修复：重译请求在目标消息“翻译已在途”时不再静默丢弃；会合并为“在途完成后补一次重译”，避免 UI 卡在“重译中”且误判成功。
- 优化：重译交互降噪：不再弹出“正在提交/已入队”双重提示；当已存在译文时仅提示一次“已完成重译/内容无变化”（首次翻译不提示）。
- 调整：NVIDIA `max_tokens` 默认改为 8192（输出上限；可设为 0 表示不传该字段；如触发 400 上下文超限会自动 clamp 并重试一次）。
- 新增：保存翻译设置后自动进行一次“翻译自检”请求（无需手动点测试按钮），并以 toast 提示成功/失败原因，便于快速确认 Key/模型/权限是否可用。
- 优化：NVIDIA Provider 增加 Markdown 保真质量门控：当输出缺失标题 `#` 或代码围栏 ```（输入中存在时），会在 4 个内置模型内自动回退，降低“标题/代码块被漏翻译或格式丢失”的概率。
- 调整：NVIDIA `RPM` 默认改为 0（不主动节流）；如遇 429 再按需开启节流（仍保留 429 退避重试）。
- 新增：NVIDIA Provider 支持 `max_tokens`（默认 8192）以降低长文本截断概率，并在 UI 增加 `Max Tokens` 配置项。
- 修复：批量翻译（`<<<SIDECAR_TRANSLATE_BATCH_V1>>>`）的 marker 解包正则错误，避免批量翻译结果“看似成功但译文缺失”。
- 优化：批量翻译提示词更严格，并在解包缺失时对缺失项回退单条翻译，避免 UI 出现漏段。
- 优化：单条翻译提示词补齐“逐行翻译/不改写结构/标题 `#` 前缀保留”等约束，降低“漏标题格式/自动改成列表/合并段落”的概率。
- 优化：NVIDIA Provider 在 400 “maximum context length ...” 错误时自动降低 `max_tokens` 并重试一次，避免用户把 `max_tokens` 设太大导致空译文。
- UI：NVIDIA `Model` 使用单一 `select` 下拉，固定 4 个可切换模型。
- 修复：如本机配置中存在历史遗留的 NVIDIA model id（例如 `nvidia/riva-translate-4b-instruct-v1_1`），sidecar 会在加载时直接重置为默认模型并写回 `config.json`，避免反复触发 404/空译文。
- 精简：NVIDIA `Model` 内置候选仅保留 4 个“翻译指令跟随更稳”的模型；移除 `nvidia/riva-translate-*` 等明显不稳定/易 404 的模型。
- UI: “有新输出”未读提示默认仅对“回答输出/审批提示”生效（忽略 tool_call/tool_output 等噪音），且右下角 toast 不再遮挡 ↑/↓ 浮动按钮。
- UI: 右下角通知 toast 改为不抢占点击，并避开右下角跳转按钮区域，避免影响 ↑/↓ 交互。
- UI: 新增通知提示音配置（`notify_sound`）：设置中可选无/舒缓-1/2/3；音效文件随 UI 静态资源提供（`ui/music/`，Kenney CC0）。
- UI: 未读提示增强：会话书签增加未读徽标（数字）；切换到会话会清空该会话未读；未读不再以“有新输出”常驻 toast 占屏（仅保留 tool gate 等关键状态 toast）。

- UI: 拆分 `ui/app/markdown.js` / `ui/app/decorate.js`，引入子目录实现（保持纯静态，无构建）
- 新增：UI 控制面（保存配置、开始/停止监听、清空显示）+ 短命令 `./ui.sh`。
- 优化：`./ui.sh` 当端口已有健康服务时直接打开已有 UI 并退出，避免端口占用反复报错。
- 新增：翻译 Provider 预留与 UI 切换（stub/none/http/openai）。
- 新增：GPT（Responses API 兼容）翻译 Provider（支持 OpenAI/兼容中转站如 right.codes；鉴权支持 Authorization/x-api-key；可选 reasoning_effort）。
- 新增：HTTP Profiles（可保存多个翻译 API 配置并手动切换）。
- 调整：`./run.sh` 默认沿用已保存配置（未显式传参时不再用默认值覆盖）。
- 新增：HTTP Token 字段（可用于 Header 鉴权或替换 URL 中 `{token}`，方便对接 DeepLX）。
- 新增：UI 显示模式（仅中文/仅英文/中英对照）。
- 修复：HTTP 翻译适配更多常见入参/回参字段，降低“无译文”的概率。
- 优化：保存配置时提示重启监听以立即生效；UI 响应增加 no-cache 避免浏览器缓存旧页面。
- 修复：为 `/api/config` 与 `/api/translators` 增加向后兼容字段，避免旧版 UI（缓存）无法读取配置导致“配置丢失”错觉。
- 优化：控制面板接口请求增加 cache-bust，API 响应标记为 no-store，避免浏览器缓存导致配置不刷新。
- 优化：控制面板新增“调试信息”面板，显示配置来源/Profiles 概览与加载失败原因（不展示 token/url）。
- 修复：保存配置时不再在 Provider≠HTTP 的情况下清空已保存的 HTTP Profiles，避免误操作导致配置丢失。
- 调整：translator_config 支持按 Provider 分区保存（`http/openai`）并在保存时合并，避免切换 Provider 覆盖其它配置。
- 调整：配置持久化迁移到 XDG（`~/.config/codex-thinking-sidecar/config.json`），备份机制简化为单文件 `config.json.bak`；Profiles 为空时 UI 提示一键恢复，后端拒绝保存空 Profiles 以防误覆盖。
- 诊断：HTTP 翻译失败时输出去敏后的告警日志（终端可见）。
- 新增：HTTP 适配 `translate.json`（硅基流动 translate.js 形式，表单提交）。
- 优化：UI 列表改为从上到下（新内容在底部），并展示用户输入/工具调用与输出/最终回答。
- 调整：仅翻译思考类内容（reasoning summary / agent_reasoning），工具输出与最终回答不翻译。
- 新增：WSL2/Linux 下可选“进程优先定位”当前会话文件（扫描 `/proc/<pid>/fd`），更精准地跟随正在进行的会话。
- 新增：会话切换列表固定在页面左侧 sidebar，滚动到中后段也可随时切换。
- 新增：UI 配置支持“自动开始监听（UI）”与进程匹配规则。
- 新增：CLI 支持 `--follow-codex-process` / `--codex-process-regex` / `--allow-follow-without-process`。
- 优化：tool_call/tool_output 展示更友好（`shell_command` 命令块高亮、tool_output 提取 Exit/耗时/Output 正文，并保留“原始输出/参数”可展开）。
- 新增：UI 右下角悬浮“↑ 顶部 / ↓ 底部”按钮，便于快速跳转页面上下。
- 优化：消息时间戳统一按北京时间展示（不再额外显示 UTC 行）。
- 优化：tool_call 默认折叠展示（点击展开），摘要更智能地跳过 `set -euo pipefail` 等 bash prologue（`update_plan` 例外：直接渲染）。
- 优化：tool_output 默认展示精简的 “Ran … + 关键输出摘要”，并移除 call_id/Exit/耗时 等噪音字段。
- 优化：对 Codex 的 “• Edited … (+x -y)” 改动摘要做结构化渲染（按文件分卡片、diff 行高亮、避免长行强制换行）。
- 优化：`shell_command` 的 `tool_output` 对 `rg` 输出做更智能的折叠（只展示命中的文件路径 + 嵌套的 `\\n` 行数估计 + 其余匹配数量）。
- 优化：`shell_command` 的 `tool_output` 默认直接展示终端风格块（`• Ran ...` + `│/└` 树形摘要），并在“详情”中展示完整命令与更多输出。
- 优化：隐藏 `shell_command/view_image` 的 `tool_call` 行，避免与 `tool_output` 重复；并调整树形缩进/`|| true` 换行，更贴近终端样式。
- 优化：`tool_output` 的“详情”按钮移动到时间戳行（更省空间），点击后直接展开完整详情（不再二次折叠）。
- 优化：`tool_output` 的“详情/收起”改为摘要与完整内容互斥切换（避免展开后出现两条重复块）。
- 优化：命令摘要换行优先在 `|` / `&&` / `||` 处分段，避免参数被孤立到单独一行导致观感割裂。
- 优化：meta 行为工具输出/工具调用/输入/回答补充“类型 + 工具名”标识，统一信息位置。
- 修复：预扫描 `tool_call` 建立 call_id→tool 索引，解决部分 `tool_output` 无法识别工具而展示 raw JSON 的问题。
- 优化：`apply_patch` 详情使用统一 diff 高亮（`+/-/@@`）渲染，便于快速扫读增删改。
- 修复：diff 渲染不再“每行空一行”，行距与分段更紧凑。
- 优化：复制按钮改为小图标（⧉），避免遮挡内容。
- 优化：用户输入（user_message）正文改为 Markdown 渲染，且不再在正文重复“用户”标签（统一放在 meta 行）。
- 优化：隐藏 `apply_patch` 的 `tool_call` 行；`apply_patch` 的 `tool_output` 改为终端风格摘要，并在“详情”中提供补丁内容可复制。
- 优化：`update_plan` 不再折叠展示，按“计划→说明”输出并使用 Markdown 排版，移除原始参数与工具元信息。
- 优化：回答内容（assistant_message）改为 Markdown 渲染。
- 新增：所有消息的文本块/代码块右上角增加“复制”按钮。
- 优化：思考块（`reasoning_summary`/`agent_reasoning`）改为 Markdown 渲染，并将“思考（EN/ZH）”移到时间戳同行。
- 调整：↑ 顶部 / ↓ 底部悬浮按钮移动到右侧。
- 重构：UI HTML 从 `server.py` 抽离到 `tools/codex_thinking_sidecar/codex_thinking_sidecar/ui/index.html`，便于后续分层与迭代。
- 修复：UI Markdown 渲染支持有序列表（`1.` / `1)`）与 `•/◦` 无序列表，避免回答分点在 UI 中丢失。
- 优化：主页面控制收敛到右侧悬浮工具栏（⚙️/▶️/⏹️/🧹/⏻），顶栏仅保留标题与状态。
- 新增：手动退出 Sidecar（`/api/control/shutdown` + UI 按钮），便于无需手动 kill PID 的情况下关闭进程。
- 优化：Codex 的改动摘要不再额外展示“原始文本”二次折叠层，减少冗余。
- 重构：UI 静态资源进一步分层为 `ui/index.html` + `ui/styles.css` + `ui/app.js`，服务端提供 `/ui/*` 静态路由。
- 新增：会话侧栏支持折叠为“圆点模式”，hover 查看会话信息以节省屏幕空间。
- 优化：会话侧栏默认“自动隐藏”，鼠标移到最左侧热区才浮现（进一步释放主内容宽度）。
- 调整：移除会话侧栏“圆点折叠”模式（避免双重折叠），侧栏始终以列表展示。
- 新增：会话侧栏支持自定义标签（右键/双击会话项设置，留空可清除；本机浏览器 localStorage 持久化）。
- 修复：首次启动配置迁移补齐 legacy `.lastgood`/`.bak-*` 扫描，降低“配置丢失且无法恢复”的概率。
- 优化：tool_output 的“详情”不再重复显示工具/call_id/Exit/耗时等头信息，直接展示终端风格正文；并用唯一 id 保证展开/收起不会误操作到其它块。
- 优化：会话侧栏默认折叠并压缩宽度；圆点/标签为每个会话分配稳定色彩，提升多会话区分度。
- 优化：复制按钮缩小并移出代码块顶部避免遮挡；思考分隔线仅在双语同显时出现。
- 优化：顶栏 `/api/messages` 与 `/api/threads` 改为可点击链接，便于快速自检数据源。
- 重构：UI JavaScript 拆分为 ES Modules（解析/格式化/渲染/控制解耦），服务端支持按需静态加载 `/ui/*` 资源。
- 优化：配置抽屉更极简（常用项优先；HTTP Profiles 操作改为图标按钮；非 HTTP Provider 时隐藏 HTTP 配置块）。
- 完善：会话侧栏“圆点模式”使用自定义 tooltip（不依赖浏览器 title），并在圆点上展示消息数徽标提升区分度。
- 修复：tool_output “详情/收起”切换时同步隐藏复制按钮容器，避免出现空白占位/看似重复两条的问题。
- 修复：`apply_patch` 的 Add File/Update File 也提供“详情”展开（显示完整 patch 内容并做 diff 高亮）。
- 优化：用户输入（user_message）检测到前缀为日志/代码时自动拆分为“代码块 + 正文 Markdown”，避免换行被合并导致难以阅读。
- 优化：移除消息正文区域的 hover title（避免出现 `tool_output ...` 这类无意义悬浮提示）；并支持代码块“单击切换详情 / 长按复制”。
- 优化：复制反馈更明显：复制成功会弹出“已复制”提示并自动淡出。
- 优化：HTTP 翻译返回空译文时自动降级为“显示原文 + 顶部告警提示”，避免中文模式下出现（空）。
- 新增：右侧工具栏加入“重启 Sidecar”按钮（杀死并重新拉起新进程，用于开发时快速重载代码）。
- 优化：重启流程基于 `/health` 的 `pid` 判断是否已产生新进程，并在状态栏补充 `sidecar:<pid>` 便于确认。
- 修复：回放/切换文件/重复启动 watcher 时，服务端按消息 id 去重，避免历史消息重复追加。
- 优化：复制交互统一：各内容块支持长按复制（pointerup 触发更稳定）；tool-card 空白区域也可长按复制；移除每条消息右上角复制按钮以减少遮挡。
- 修复：tool_call（如 web_search_call）不再默认折叠，直接以 tool-card 代码块展示调用参数，避免“需要再点开一次”。
- 修复：页面加载/清空显示时同步后端 follow(pin/auto) 状态，避免多会话下“监听跑偏/输出项不一致”的错觉。
- 修复：`apply_patch` 的 tool_call 解析支持“payload 在 call_id 之前”的变体，确保 Add File/Update File 也能展开“详情”。
- 修复：停止监听时若存在翻译请求在途，UI 会显示“停止中”并轮询直到真正停止；watcher 退出后的状态会被自动清理，避免按钮/状态卡住。
- 优化：HTTPServer 启用端口复用（`allow_reuse_address=true`），提升重启 Sidecar 的成功率（避免 TIME_WAIT 导致 EADDRINUSE）。
- 修复：时间线“回跳”从兜底刷新改为排序不变式：UI 收到 SSE 后按 `(timestamp, seq)` 插入到正确位置；服务端为每条消息附加自增 `seq`，会话列表按 `last_seq` 排序，避免不同 timestamp 形态导致排序不稳定。
- 修复：当 `update_plan` 的 tool_call 丢失时，其 `Plan updated` 的 tool_output 不再作为“未知工具”噪音显示。
- 优化：翻译请求去重：Watcher 先做 dedupe 再发起翻译，避免重复消息也重复请求翻译 API。
- 优化：OpenAI/Responses 翻译器增加 LRU 缓存（默认 64 条），减少同内容重复翻译请求。
- 优化：UI 选择 OpenAI Provider 时自动补齐默认 Base URL（right.codes）与默认模型（gpt-4o-mini），减少手动配置成本。
- 重构：翻译实现拆分为 `codex_thinking_sidecar/translators/*`，`translator.py` 仅作为向后兼容的 facade。
- 修复：OpenAI/Responses 翻译鉴权头的 Bearer 前缀自动补空格，避免 `Authorization: Bearersk-...` 导致 401 “缺少 API Key”。
- 修复：停止监听不再提前清空 watcher 线程引用，避免“停止未完成又启动”导致的重复监听/重复翻译请求。
- 调整：保存配置后的“立即生效”改为直接复用右侧 🔄 的“重启 Sidecar”逻辑（更确定，不受 in-flight 翻译请求影响）。
- 调整：right.codes（Codex 网关）默认模型改为 `gpt-5.1`（避免部分 ChatGPT 账号不支持 `gpt-4o-mini` 导致 400，同时较 `gpt-5.2` 更省）。
- 新增：UI Markdown 渲染支持表格（pipe table），输入/输出里含 `|---|` 的表格会渲染为 HTML table。
- 修复：兼容部分网关在 `stream:false` 时仍返回 `text/event-stream`（SSE）；翻译器会解析 SSE 事件并提取 `output_text`，避免把整段 `event: response.created ...` 原样展示到思考内容里。
- 优化：OpenAI/Responses 翻译请求增加 `Accept: application/json`，并缩短翻译 prompt 以减少 token 消耗（同时仍保持 Markdown/代码块保真规则）。
- 修复：OpenAI/Responses 翻译器在批量翻译（`<<<SIDECAR_TRANSLATE_BATCH_V1>>>`）场景下不再额外包裹“只输出译文”的通用翻译 prompt，避免标记行被翻译/改动导致批量解包失败与性能退化。
- 新增：监听 `codex-tui.log` 的 tool gate 状态（`waiting for tool gate` / `tool gate released`），在 UI 中提示“终端等待确认/已确认”，避免需要授权时 UI 看起来卡住。
- 修复：tool gate 长时间等待时不再反复推送“waiting”消息刷屏（仅在状态变化时发一条），避免会话计数膨胀与列表被挤满。
- 修复：tool gate 事件识别改为严格匹配 `codex-tui.log` 的标准日志行（ISO 时间戳 + `INFO waiting/released`），避免工具输出/grep 等包含相同字样时误报“终端等待确认”。
- 修复：`watch/procfs.py` 缺少 `Optional` 导入导致 sidecar 无法启动（`NameError: Optional is not defined`）。
- 诊断增强：`/api/status` 增加翻译队列统计（hi/lo 队列长度、最近一次翻译耗时、drop 计数），UI 调试信息面板展示这些指标，用于定位“ZH 翻译中…”变慢是队列积压还是模型/网络耗时。
- 新增：多会话场景下支持“锁定跟随”（可选）：侧栏“锁定”开关开启时，点击会话会将 watcher 固定到该 thread/file；关闭则仅切换视图，不阻止新会话被发现/进入 sidebar。
- 修复：UI 切换“锁定”开关会立即同步后端 follow 状态：关闭时自动释放 pin（回到 auto），开启时会将当前会话立即 pin（无需再点一次会话）。
- 修复：回放行数严格遵循配置（不再在“窗口内无 reasoning”时自动扩窗到 5000 行），避免误以为在不断回溯旧消息并触发大量历史翻译。
- 修复：启动时对 `codex-tui.log` 的 tool gate 尾部扫描增加“新鲜度”过滤，避免历史残留的 `waiting for tool gate` 被误报为当前需要确认。
- 新增：思考行增加“翻译/重译”按钮，可对单条思考强制重新翻译（`/api/control/retranslate`），译文仍以 `op=update` 回填到原位；并支持单条思考的 EN/ZH/对照切换（不影响全局显示模式）。
- 修复：当 `apply_patch` 以 `shell_command` here-doc 形式执行时，tool_output 的“详情”现在会展示 patch 本体并做 diff 高亮（不再只看到 `Success...` 摘要）。
- 修复：Markdown 渲染对终端换行更友好（中文不再出现“会 话”这类断词空格），并将 `────` 分隔行独立成块，避免与下一行合并导致结构错乱。
- 新增：Watcher 支持并行 tail 最近 N 个会话文件（配置项 `watch_max_sessions`，默认 3），满足“至少 3 个会话同时实时更新”；锁定（pin）仅影响主跟随，不阻断后台摄取与侧栏会话发现。
- 新增：UI 配置加入“并行会话”输入框（maxSessions），用于配置 `watch_max_sessions`（保存后立即生效，无需重启监听）。
- 优化：保存配置后可运行时热更新 watcher 参数（采集 `agent_reasoning`、进程定位/regex、poll/scan 等）；仅“监视目录”需要停止后再开始监听才能切换。
- 修复：UI 状态/调试信息里可显示 `tail:N` 与翻译队列统计，便于定位“翻译慢”是队列积压还是模型/网络耗时。
- 新增：翻译模式 `translate_mode=auto|manual`：`auto` 自动翻译思考；`manual` 仅在单击思考块或点“翻译/重译”时才发起翻译请求。
- 优化：未译时默认只显示英文原文，状态栏以 pill 提示“ZH 待翻译/翻译中/已就绪”；译文回填后默认切到中文，单击思考块可在 EN/ZH 间切换。
- 防抖：手动翻译增加 in-flight 保护，避免重复点击导致多次翻译请求；翻译队列也会忽略同一条消息的重复 force 触发。
- 修复：当某条仍在翻译中再次点击“重译”，会排队一次后续重译（等待当前翻译完成），避免“闪一下但没发请求/没执行”的困惑。
- 修复：`TranslationPump` 在批量翻译的边界分支也会清理 inflight，避免后续重译被永久合并导致“入队但不执行”。
- 新增：对 `require_escalated` 等需要终端批准的工具调用，Watcher 会主动推送一条 `tool_gate` 提示到 UI（不依赖 codex-tui.log），降低“终端在等你确认但 UI 看起来没反应”的困惑。
- 修复：翻译失败（超时/空译文）不再把告警文本写入 `zh`（避免 UI 误判“ZH 已就绪”并污染内容区）；改为回填 `translate_error`，UI 用状态 pill 展示失败并支持“重试”。
- 修复：重新翻译会清空 `zh` 时，UI 不再被旧的“单条显示模式”覆盖导致英文被隐藏（无 `zh` 时强制显示 EN）。
- 优化：工具“需要终端批准”提示（`tool_gate`）不再展示 `call_id`，并把“原因”明确标注为 `justification`（来自 tool_call 参数）。
- 新增：右侧工具栏加入“快速浏览”开关（精简显示）：仅显示输入/输出/思考三类块，用于快速扫读；不影响 SSE 摄取与时间线。
- 新增：右下角通知提示（toast）：tool gate 等关键状态可弹出提醒，避免切换会话/不在底部时错过。
- 修复：思考块 EN/ZH 切换、代码块详情/摘要切换后自动做滚动锚点修正，避免高度变化导致“第二次单击落点偏移/点空”。
- 安全：终端批准提示（tool gate/需要批准）在展示命令与理由时做简单脱敏（`sk-***` / `Bearer ***`），避免敏感信息误入 UI。
- 新增：侧栏会话管理（安全优先）：导出当前会话为 Markdown（⤓）、隐藏当前会话（🙈）、显示隐藏会话（👁）；仅使用本机 localStorage，不删除任何 `rollout-*.jsonl`。
- 新增：`all` 视图下每条消息显示所属会话标识（rollout 时间戳 + thread_id 片段），降低多会话混在一起的“错乱感”。
- 修复：tool_call 权限升级提示降级为“可能需要终端确认”（不再误报为确定的 tool gate waiting），并在通知摘要中提示“可能是历史残留”。
- 修复：配置解析更健壮：容忍 `config.json` 中数字字段为非法字符串/空值，避免启动时报 `ValueError`。
