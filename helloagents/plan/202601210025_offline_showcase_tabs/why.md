# 变更提案: 离线展示会话（展示中）+ 双标签栏

## 需求背景
当前 UI 将“实时监听中的会话”和“离线展示的历史会话”混在同一套会话列表/底部标签栏里，容易产生以下问题：

1. 误解会话状态：用户以为“展示历史”会影响 watcher 的跟随/监听策略。
2. 导航干扰：离线会话混入底部标签栏，容易与“监听标签页栏”的行为与设定重叠。
3. 能力割裂：离线仅用于回看历史，但“思考翻译”等交互希望不依赖 watcher 运行即可使用。

本变更将离线视图明确为“展示中（只读）”，在 UI 上与“监听中（实时）”做结构隔离，同时复用现有渲染与导出能力，减少额外复杂度。

## 产品分析

### 目标用户与场景
- **用户群体:** 高频使用 Codex 的开发者/维护者，需要长期回看、对比与导出历史对话
- **使用场景:**
  - Codex 未运行时，仍可打开历史 rollout 文件回看对话
  - 多会话并行工作时，需要区分“实时监听”和“离线展示”
  - 导出历史会话（含可选的思考译文补齐）
- **核心痛点:** 离线会话与监听会话的导航/状态混淆，导致误操作与认知负担

### 价值主张与成功指标
- **价值主张:** 通过“监听中/展示中/关闭监听”三列表 + 双标签栏，把实时态与离线态彻底隔离，离线浏览零副作用
- **成功指标:**
  - 离线会话不触发 `/api/control/follow`、不产生未读/铃声
  - 离线会话可独立出现在“展示标签栏”，并可关闭而不影响“监听标签页栏”
  - 离线思考翻译可在 watcher 未运行时完成

### 人文关怀
- **隐私提示:** 翻译可能会将文本发送到第三方 Provider（由用户配置），需在 UI/文档中保持明确提示
- **可访问性:** 新增/调整的按钮需具备可见 focus、合理触控区域与清晰的 aria-label

## 变更内容
1. **导航结构升级：双标签栏**
   - 保留现有底部“监听标签页栏”
   - 新增一行“展示标签栏”置于其上方，仅承载离线展示会话
2. **会话管理抽屉升级：三列表**
   - 监听中：实时会话列表（现有逻辑）
   - 展示中：离线会话列表（可关闭/移除展示）
   - 关闭监听：现有“已关闭监听”列表
3. **离线标识与缓存策略（稳定且不与 Live 冲突）**
   - 离线会话 key：`offline:${encodeURIComponent(rel)}`
   - 离线消息 id：`off:${key}:${sha1(rawLine)}`
   - 离线译文缓存：`localStorage`，key 为 `offlineZh:${rel}`，值为 `{ [msg_id]: zh }`
4. **翻译接口复用**
   - 新增 `POST /api/control/translate_text`：对任意文本做翻译（不依赖 SidecarState/watcher）
   - 离线思考翻译与离线导出补齐译文统一走该接口

## 影响范围
- **模块:** `codex_sidecar/http`、`codex_sidecar/offline`、`ui/app`（sidebar/tabs、control/wire、thinking_rows、export、offline utils）
- **文件:** 见 task.md
- **API:**
  - 新增：`POST /api/control/translate_text`
  - 变更：`GET /api/offline/messages` 返回的 `key`、`id` 生成规则（用于 UI 隔离与缓存）
- **数据（本机）：**
  - 新增 `localStorage`：`offlineZh:${rel}`（离线译文缓存）
  - 新增 `localStorage`：展示中离线会话列表（用于“展示中”持久化与恢复）

## 核心场景

### 需求: 离线展示会话（展示中）
**模块:** UI / 离线数据源

#### 场景: 从“展示名单/最近文件”打开历史会话
- 离线会话进入“展示中”列表，并出现在“展示标签栏”
- 主视图切到离线会话，消息按现有渲染逻辑展示
- 不触发 watcher 跟随/监听，不产生未读/铃声

#### 场景: 关闭展示标签
- 仅从“展示标签栏”移除（不影响文件）
- 仍可从“展示中”列表再次打开

#### 场景: 离线思考翻译/重译
- 点击“翻译/重译”后调用 `/api/control/translate_text`
- 译文回填到当前行并写入 `offlineZh:${rel}` 缓存
- watcher 未运行也可完成

## 风险评估
- **风险:** 离线文件路径被滥用读取任意文件
  - **缓解:** 仅允许 `CODEX_HOME/sessions/**/rollout-*.jsonl`，服务端强校验路径与文件名（已有能力，变更时保持不回退）
- **风险:** 翻译向第三方发送内容
  - **缓解:** 明确文档提示；接口响应不返回任何 secret；保持最小返回字段
- **风险:** 大文件离线渲染性能
  - **缓解:** 继续沿用 `tail_lines` 上限与前端增量渲染/装饰策略；导出翻译做上限与超时控制

