# 变更提案: Codex SDK 控制模式（浏览器输入 → 本机持续对话）

## 需求背景
当前项目以“旁路只读”方式展示 Codex 会话（rollout JSONL），但无法在 UI 内直接继续对话或提交新的指令。
理想体验是：在浏览器中像使用终端 Codex 一样持续对话——输入一段信息，Codex 在本机执行并输出结果，且能在会话中继续追问/迭代。

## 产品分析

### 目标用户与场景
- **用户群体:** 本机使用 Codex 进行开发/调试的工程师
- **使用场景:** 已打开 sidecar UI 观察输出，希望不切回终端即可继续输入并驱动 Codex 执行
- **核心痛点:** 旁路 UI 只能“看”，不能“继续聊/继续做”

### 价值主张与成功指标
- **价值主张:** 将“阅读 + 输入”统一到一个浏览器面板中，减少终端/浏览器来回切换带来的上下文损耗
- **成功指标:**
  - 发送输入后，UI 能在可接受延迟内看到 Codex 输出（支持流式更佳）
  - 支持同一会话多轮对话，并能恢复/续聊
  - 不影响现有 rollout 旁路监听能力（默认路径仍可用）

### 人文关怀
- **安全优先:** 该能力等价于“在本机执行命令/修改文件”的入口，必须默认仅允许本机访问、明确提示风险，并提供最小化暴露面
- **隐私保护:** 不在 UI/日志中泄露密钥；对敏感信息做去敏/避免持久化（除非用户明确开启）

## 变更内容
1. 新增 `codex_sdk` 模块：用 Codex SDK 在本机静默启动/恢复 thread，并支持持续对话输入。
2. UI 新增“控制模式”：输入框、会话管理（threadId）、中断、（可选）审批/确认流程。
3. 启动脚本升级为“一键启动”旁路监听 + SDK 控制（可选启用，不改变默认只读体验）。
4. 安全：仅绑定 `127.0.0.1`、CSRF token/本地随机口令、显式开关与风险提示。

## 影响范围
- **模块:**
  - `rollout_sidecar`（既有旁路展示能力，UI 增加控制入口与消息呈现）
  - `codex_sdk`（新增：输入/输出/会话管理）
- **文件（计划）:**
  - `src/codex-sdk/`（新增目录，承载 SDK 相关实现）
  - `tools/codex_thinking_sidecar/codex_thinking_sidecar/server.py`（新增 API 或代理聚合）
  - `tools/codex_thinking_sidecar/codex_thinking_sidecar/ui/*`（新增输入与会话管理 UI）
- **API（计划）:** `/api/sdk/*`
- **数据（计划）:** threadId 的本地持久化策略（localStorage / 配置文件 / 显式导出）

## 核心场景

### 需求: 在浏览器中持续对话
**模块:** codex_sdk
在浏览器中直接输入，驱动 Codex 在本机执行并返回输出；同一 thread 支持多轮。

#### 场景: 新建并开始一段对话
- 打开 UI → 启用“控制模式” → 新建 thread
- 输入文本 → UI 收到输出（优先支持流式）
- 后续继续输入，多轮对话保持上下文

#### 场景: 续聊/恢复 thread
- 重新打开 UI（或刷新）后仍可继续既有 thread（通过 threadId 恢复/绑定）
- 可在 UI 中切换/管理多个 thread

#### 场景: 中断当前执行
- 当一次执行耗时较长或卡住时，UI 可发起 interrupt

#### 场景: 需要人工确认/审批（可选）
- 当 Codex 需要用户确认（例如潜在危险操作）时，UI 能展示“待确认”并将用户决策回传

### 需求: 保持旁路监听能力不退化
**模块:** rollout_sidecar
SDK 控制能力上线后，原有“监听 rollout JSONL + 翻译 + UI 展示”仍可单独运行，且默认行为不改变。

## 风险评估
- **风险:** Web UI 变成“本机执行入口”（误暴露到局域网/公网将非常危险）
  - **缓解:** 默认仅 `127.0.0.1`；控制接口需 CSRF token/本地口令；UI 明示风险与开关；禁用跨域
- **风险:** 会话/输出包含敏感信息泄露到日志/持久化
  - **缓解:** 默认不持久化敏感字段；日志去敏；明确提示用户不要粘贴密钥
- **风险:** 资源占用（常驻 thread/后台执行）导致机器卡顿
  - **缓解:** 限制并发；提供显式停止/中断；超时与回收策略

